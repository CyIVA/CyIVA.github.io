<section id="tag-list">
  <div class="categories">
    <!-- prettier-ignore -->

    {% assign CATEGORY = "" | split: ',' %} 
    {% for post in site.posts %} 
        {% for c in post.categories %} 
            {% assign c_upper = c | upcase %}
            {% assign CATEGORY = CATEGORY | push: c_upper %} 
        {% endfor %} 
    {% endfor %}
    <!-- collect tag -->
    {% assign CATEGORYS = CATEGORY | uniq %}

    <!-- tag add -->
    {% for c in CATEGORYS %}

    <a href="#!" data-base-url="{{site.baseurl}}" class="category" data-category="{{c}}">
      {{c}} <span id="count-{{c}}" class="category_count"></span>
    </a>
    {% endfor %}

    <script>
      // Use jsonify for safe array transfer
      var js_categories = {{ CATEGORY | jsonify }}; 
      
      // 1. Calculate counts based on Uppercase keys
      let categoryCounts = {};
      js_categories.forEach(category => {
        let key = category.trim().toUpperCase();
        if (!categoryCounts[key]) {
          categoryCounts[key] = 0;
        }
        categoryCounts[key]++;
      });

      // 2. Process DOM elements to dedup and update
      let processedKeys = new Set();
      const tagElements = document.querySelectorAll('#tag-list .category');

      tagElements.forEach(el => {
        let originalCategory = el.getAttribute('data-category');
        // Handle potential null or empty
        if (!originalCategory) return;
        
        let key = originalCategory.trim().toUpperCase();

        if (processedKeys.has(key)) {
          // Duplicate! Hide it.
          el.style.setProperty('display', 'none', 'important');
        } else {
          // First time seeing this key. Keep it.
          processedKeys.add(key);
          
          // Update Count
          let countSpan = el.querySelector('.category_count');
          if (countSpan) {
            countSpan.innerText = "(" + categoryCounts[key] + ")";
          }

          // Update Label to Uppercase
          // Update only the text node to preserve the span
          for (let node of el.childNodes) {
            if (node.nodeType === Node.TEXT_NODE) {
              node.textContent = key + ' ';
              break; 
            }
          }
        }
      });
    </script>
  </div>
</section>
